name: Scheduled Maintenance

on:
  schedule:
    # 毎週月曜日 9:00 JST (00:00 UTC)
    - cron: '0 0 * * 1'
  workflow_dispatch: # 手動実行を許可

jobs:
  # ==========================================
  # Dependency updates check
  # ==========================================
  dependency-check:
    name: Check Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v6

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5

      - name: Cache dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # 依存関係の更新確認
      - name: Check for outdated dependencies
        run: bun outdated || true

      # セキュリティ脆弱性チェック
      - name: Security audit
        run: bun pm audit || true

      # 循環依存チェック
      - name: Check circular dependencies
        run: bun run analyze:circular || true

  # ==========================================
  # Code quality metrics
  # ==========================================
  code-quality:
    name: Code Quality Metrics
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0 # 全履歴を取得（コード重複分析のため）

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5

      - name: Cache dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # コード重複検出
      - name: Check code duplication
        run: bun run analyze:duplication || true

      # 未使用のエクスポート検出
      - name: Check unused exports
        run: bun run analyze:unused || true

  # ==========================================
  # Test coverage report
  # ==========================================
  coverage-report:
    name: Generate Coverage Report
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      NODE_ENV: test
      DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
      DOTENV_PRIVATE_KEY_PRODUCTION: ${{ secrets.DOTENV_PRIVATE_KEY_PRODUCTION }}

    steps:
      - uses: actions/checkout@v6

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5

      - name: Cache dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # 本番DBブランチから一時ブランチを作成（本番環境のデータでテスト）
      - name: Create Neon branch from production
        run: NEON_PARENT_BRANCH_ID=br-quiet-brook-a7skh7bx bunx dotenvx run -f projects/.env -- bun scripts/neon-branch.ts create

      - name: Update DATABASE_URL to use Neon branch
        run: echo "DATABASE_URL=$NEON_DATABASE_URL" >> $GITHUB_ENV

      - name: Run migrations
        run: |
          bunx cross-env NODE_OPTIONS="--no-deprecation --import tsx" \
            PAYLOAD_CONFIG_PATH=src/payload.config.ts \
            payload migrate:fresh --force-accept-warning
        env:
          PAYLOAD_SECRET: ci-test-secret-key-for-scheduled-maintenance

      # 全テストのカバレッジを収集
      - name: Run tests with coverage
        run: bunx dotenvx run -f projects/.env.production -- bun run test:coverage:all
        env:
          PAYLOAD_SECRET: ci-test-secret-key-for-scheduled-maintenance

      - name: Cleanup Neon branch
        if: always()
        run: bunx dotenvx run -f projects/.env -- bun scripts/neon-branch.ts delete

      # カバレッジレポートをアップロード
      - name: Upload coverage to Codecov
        run: bunx dotenvx run -- codecov --file ./coverage/coverage-final.json --flags scheduled --name scheduled-coverage

  # ==========================================
  # Performance benchmarks
  # ==========================================
  performance-benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      NODE_ENV: test
      DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
      DOTENV_PRIVATE_KEY_PRODUCTION: ${{ secrets.DOTENV_PRIVATE_KEY_PRODUCTION }}

    steps:
      - uses: actions/checkout@v6

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5

      - name: Cache dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # Install Playwright browsers for performance tests
      - name: Install Playwright browsers
        run: bun run test:e2e:install

      # 本番DBブランチから一時ブランチを作成（本番環境のデータでテスト）
      - name: Create Neon branch from production
        run: NEON_PARENT_BRANCH_ID=br-quiet-brook-a7skh7bx bunx dotenvx run -f projects/.env -- bun scripts/neon-branch.ts create

      - name: Update DATABASE_URL to use Neon branch
        run: echo "DATABASE_URL=$NEON_DATABASE_URL" >> $GITHUB_ENV

      - name: Run migrations
        run: |
          bunx cross-env NODE_OPTIONS="--no-deprecation --import tsx" \
            PAYLOAD_CONFIG_PATH=src/payload.config.ts \
            payload migrate:fresh --force-accept-warning
        env:
          PAYLOAD_SECRET: ci-test-secret-key-for-scheduled-maintenance

      # パフォーマンステスト実行
      - name: Run performance tests
        run: bunx dotenvx run -f projects/.env.production -- vitest run src/__tests__/performance/
        env:
          PAYLOAD_SECRET: ci-test-secret-key-for-scheduled-maintenance

      - name: Cleanup Neon branch
        if: always()
        run: bunx dotenvx run -f projects/.env -- bun scripts/neon-branch.ts delete

  # ==========================================
  # Database health check
  # ==========================================
  database-health:
    name: Database Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # 本番DBに接続するため注意

    steps:
      - uses: actions/checkout@v6

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5

      - name: Check database connections
        run: |
          echo "Checking database connectivity..."
          # 実際のヘルスチェックスクリプトを実行

      # データベースバックアップ確認など追加可能
      # - name: Verify recent backups
      #   run: ./scripts/check-backups.sh

  # ==========================================
  # Summary report
  # ==========================================
  maintenance-summary:
    name: Maintenance Summary
    runs-on: ubuntu-latest
    needs: [dependency-check, code-quality, coverage-report, performance-benchmark, database-health]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# Weekly Maintenance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Check: ${{ needs.dependency-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage Report: ${{ needs.coverage-report.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Performance Benchmark: ${{ needs.performance-benchmark.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Database Health: ${{ needs.database-health.result }}" >> $GITHUB_STEP_SUMMARY

      # Slackなどへの通知を追加可能
      # - name: Send notification
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: custom
      #     fields: workflow,job,commit,repo
      #     custom_payload: |
      #       {
      #         text: 'Weekly maintenance completed',
      #         attachments: [{
      #           color: '${{ job.status }}' === 'success' ? 'good' : 'danger',
      #           text: 'Check GitHub Actions for details'
      #         }]
      #       }
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
