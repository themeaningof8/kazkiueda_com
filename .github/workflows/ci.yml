name: CI Pipeline

on:
  pull_request:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_ENV: test

jobs:
  validate-config:
    name: Validate Configuration Files
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Validate Renovate config
        run: bunx tsx scripts/validate-renovate-config.ts

  static:
    name: Static Analysis
    needs: validate-config
    uses: ./.github/workflows/reusable-tests.yml
    secrets: inherit
    with:
      suite: static

  unit:
    name: Unit Tests
    needs: static
    uses: ./.github/workflows/reusable-tests.yml
    secrets: inherit
    with:
      suite: unit
      dotenv-key-name: DOTENV_PRIVATE_KEY_DEVELOPMENT

  unit-extended:
    name: Unit Tests Extended
    needs: static
    # mainブランチのpush時のみ実行（PR時はスキップ）
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: ./.github/workflows/reusable-tests.yml
    secrets: inherit
    with:
      suite: unit-extended
      dotenv-key-name: DOTENV_PRIVATE_KEY_DEVELOPMENT

  detect-changes:
    name: Detect Change Type
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      skip_integration: ${{ steps.analyze.outputs.skip_integration }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup
        uses: ./.github/actions/setup

      - name: Analyze PR changes
        id: analyze
        run: |
          echo "Analyzing PR for dependency-only changes..."

          # Run detection script
          if bunx tsx scripts/detect-dependency-only-changes.ts; then
            echo "skip_integration=true" >> $GITHUB_OUTPUT
            echo "✓ Dependency-only changes detected - integration tests will be skipped"
          else
            echo "skip_integration=false" >> $GITHUB_OUTPUT
            echo "✓ Code/config changes detected - running full test suite"
          fi

  integration:
    name: Integration Tests
    needs: [unit, detect-changes]
    # Skip integration tests for dependency-only changes on Renovate PRs
    if: needs.detect-changes.outputs.skip_integration != 'true'
    strategy:
      fail-fast: false
      matrix:
        integration-script:
          - test:integration:payload-client
          - test:integration:collections-posts
          - test:integration:collections-users
          - test:integration:collections-media
          - test:integration:performance
    uses: ./.github/workflows/reusable-tests.yml
    secrets: inherit
    with:
      suite: integration
      dotenv-key-name: DOTENV_PRIVATE_KEY_DEVELOPMENT
      integration-script: ${{ matrix.integration-script }}

  e2e-essential:
    name: E2E Essential
    needs: integration
    uses: ./.github/workflows/reusable-tests.yml
    secrets: inherit
    with:
      suite: e2e-essential
      dotenv-key-name: DOTENV_PRIVATE_KEY_DEVELOPMENT

  coverage:
    name: Coverage Report
    needs: unit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      NODE_ENV: test
      DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
      DOTENV_PRIVATE_KEY_DEVELOPMENT: ${{ secrets.DOTENV_PRIVATE_KEY_DEVELOPMENT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup
        uses: ./.github/actions/setup

      - name: Install Playwright browsers
        run: bunx playwright install chromium --with-deps

      - name: Load environment variables
        id: dotenv
        run: |
          CODECOV_TOKEN=$(bunx dotenvx get CODECOV_TOKEN -f projects/.env)
          echo "::add-mask::$CODECOV_TOKEN"
          echo "CODECOV_TOKEN=$CODECOV_TOKEN" >> $GITHUB_ENV

      - name: Build Next.js for performance tests
        run: |
          echo "Building Next.js for bundle size tests..."
          bunx dotenvx run -f projects/.env.development -- bun next build

      - name: Run unit tests with coverage
        run: |
          echo "Running unit tests with coverage..."
          bunx dotenvx run -f projects/.env.development -f projects/.env -- vitest run src/__tests__/unit --coverage --exclude src/__tests__/unit/bundle-size.test.ts --exclude src/__tests__/unit/payload-client.test.ts --exclude src/__tests__/unit/pagination.test.tsx

      - name: Upload coverage reports to Codecov
        if: always()
        uses: codecov/codecov-action@v5
        with:
          files: ./reports/coverage/lcov.info
          flags: unit
          fail_ci_if_error: false

      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1
        with:
          files: ./reports/test-results/junit.xml

      - name: Generate coverage summary
        run: |
          echo "# Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "reports/coverage/coverage-summary.json" ]; then
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat reports/coverage/coverage-summary.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage summary not found" >> $GITHUB_STEP_SUMMARY
          fi

  # Note: Vercel handles all deployments automatically via GitHub integration
  # - Production: main branch pushes
  # - Preview: Pull requests
  # No manual staging deployment needed
