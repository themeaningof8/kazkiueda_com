name: CI Pipeline

on:
  pull_request:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_ENV: test

jobs:
  static:
    name: Static Analysis
    uses: ./.github/workflows/reusable-tests.yml
    secrets: inherit
    with:
      suite: static

  unit:
    name: Unit Tests
    needs: static
    uses: ./.github/workflows/reusable-tests.yml
    secrets: inherit
    with:
      suite: unit
      dotenv-key-name: DOTENV_PRIVATE_KEY_DEVELOPMENT

  unit-extended:
    name: Unit Tests Extended
    needs: static
    # mainブランチのpush時のみ実行（PR時はスキップ）
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: ./.github/workflows/reusable-tests.yml
    secrets: inherit
    with:
      suite: unit-extended
      dotenv-key-name: DOTENV_PRIVATE_KEY_DEVELOPMENT

  integration:
    name: Integration Tests
    needs: unit
    strategy:
      fail-fast: false
      matrix:
        integration-script:
          - test:integration:payload-client
          - test:integration:posts
          - test:integration:collections-posts
          - test:integration:collections-users
          - test:integration:collections-media
          - test:integration:performance
    uses: ./.github/workflows/reusable-tests.yml
    secrets: inherit
    with:
      suite: integration
      dotenv-key-name: DOTENV_PRIVATE_KEY_DEVELOPMENT
      integration-script: ${{ matrix.integration-script }}

  e2e-essential:
    name: E2E Essential
    needs: integration
    uses: ./.github/workflows/reusable-tests.yml
    secrets: inherit
    with:
      suite: e2e-essential
      dotenv-key-name: DOTENV_PRIVATE_KEY_DEVELOPMENT

  coverage:
    name: Coverage Report
    needs: unit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      NODE_ENV: test
      DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
      DOTENV_PRIVATE_KEY_DEVELOPMENT: ${{ secrets.DOTENV_PRIVATE_KEY_DEVELOPMENT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build Next.js for performance tests
        run: |
          echo "Building Next.js for bundle size tests..."
          bunx dotenvx run -f projects/.env.development -- bun next build

      - name: Run unit tests with coverage
        run: |
          echo "Running unit tests with coverage..."
          bunx dotenvx run -f projects/.env.development -f projects/.env -- vitest run src/__tests__/unit --coverage --exclude src/__tests__/unit/bundle-size.test.ts --exclude src/__tests__/unit/payload-client.test.ts --exclude src/__tests__/unit/pagination.test.tsx

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./reports/coverage/lcov.info
          flags: unit
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./reports/test-results/junit.xml

      - name: Generate coverage summary
        run: |
          echo "# Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "reports/coverage/coverage-summary.json" ]; then
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat reports/coverage/coverage-summary.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage summary not found" >> $GITHUB_STEP_SUMMARY
          fi

  # Note: Vercel handles all deployments automatically via GitHub integration
  # - Production: main branch pushes
  # - Preview: Pull requests
  # No manual staging deployment needed
