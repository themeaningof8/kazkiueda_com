name: CI Pipeline

on:
  pull_request:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_ENV: test

jobs:
  static:
    name: Static Analysis
    uses: ./.github/workflows/reusable-tests.yml
    secrets: inherit
    with:
      suite: static

  unit:
    name: Unit Tests
    needs: static
    uses: ./.github/workflows/reusable-tests.yml
    secrets: inherit
    with:
      suite: unit
      dotenv-key-name: DOTENV_PRIVATE_KEY_DEVELOPMENT

  unit-extended:
    name: Unit Tests Extended
    needs: static
    # Only run on main branch pushes (skip on PRs)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: ./.github/workflows/reusable-tests.yml
    secrets: inherit
    with:
      suite: unit-extended
      dotenv-key-name: DOTENV_PRIVATE_KEY_DEVELOPMENT

  integration:
    name: Integration Tests
    needs: unit
    strategy:
      fail-fast: false
      matrix:
        integration-script:
          - test:integration:payload-client
          - test:integration:posts
          - test:integration:collections-posts
          - test:integration:collections-users
          - test:integration:collections-media
          - test:integration:performance
    uses: ./.github/workflows/reusable-tests.yml
    secrets: inherit
    with:
      suite: integration
      dotenv-key-name: DOTENV_PRIVATE_KEY_DEVELOPMENT
      integration-script: ${{ matrix.integration-script }}

  e2e-essential:
    name: E2E Essential
    needs: integration
    uses: ./.github/workflows/reusable-tests.yml
    secrets: inherit
    with:
      suite: e2e-essential
      dotenv-key-name: DOTENV_PRIVATE_KEY_DEVELOPMENT

  coverage:
    name: Coverage Report
    needs: unit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      NODE_ENV: test
      DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
      DOTENV_PRIVATE_KEY_DEVELOPMENT: ${{ secrets.DOTENV_PRIVATE_KEY_DEVELOPMENT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build Next.js for performance tests
        run: |
          echo "Building Next.js for bundle size tests..."
          bunx dotenvx run -f projects/.env.development -- bun next build

      - name: Run unit tests with coverage
        run: |
          echo "Running unit tests with coverage..."
          bunx dotenvx run -f projects/.env.development -f projects/.env -- vitest run src/__tests__/unit --coverage --exclude src/__tests__/unit/bundle-size.test.ts --exclude src/__tests__/unit/payload-client.test.ts --exclude src/__tests__/unit/pagination.test.tsx

      - name: Load environment variables
        id: dotenv
        run: |
          CODECOV_TOKEN=$(bunx dotenvx get CODECOV_TOKEN -f projects/.env)
          echo "::add-mask::$CODECOV_TOKEN"
          echo "CODECOV_TOKEN=$CODECOV_TOKEN" >> $GITHUB_ENV

      - name: Upload coverage reports to Codecov
        if: always()
        uses: codecov/codecov-action@v5
        with:
          files: ./reports/coverage/lcov.info
          flags: unit
          fail_ci_if_error: false

      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1
        with:
          files: ./reports/test-results/junit.xml

      - name: Generate coverage summary
        run: |
          echo "# Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "reports/coverage/coverage-summary.json" ]; then
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat reports/coverage/coverage-summary.json >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage summary not found" >> $GITHUB_STEP_SUMMARY
          fi

  deploy-production:
    name: Deploy to Production
    needs: [e2e-essential]
    # Only run on main branch pushes (skip on PRs)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Show deployment target
        run: |
          echo "## Production Deployment Target" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: main" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: $(git rev-parse HEAD)" >> $GITHUB_STEP_SUMMARY
          echo "- Message: $(git log -1 --pretty=%B)" >> $GITHUB_STEP_SUMMARY

      - name: Install bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Vercel CLI
        run: bun install --global vercel@latest

      - name: Load Vercel configuration from dotenvx
        id: load-vercel-config
        env:
          DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
        run: |
          VERCEL_TOKEN=$(bunx dotenvx get VERCEL_TOKEN -f projects/.env)
          VERCEL_ORG_ID=$(bunx dotenvx get VERCEL_ORG_ID -f projects/.env)
          VERCEL_PROJECT_ID=$(bunx dotenvx get VERCEL_PROJECT_ID -f projects/.env)
          echo "::add-mask::$VERCEL_TOKEN"
          echo "::add-mask::$VERCEL_ORG_ID"
          echo "::add-mask::$VERCEL_PROJECT_ID"
          echo "VERCEL_TOKEN=$VERCEL_TOKEN" >> $GITHUB_ENV
          echo "VERCEL_ORG_ID=$VERCEL_ORG_ID" >> $GITHUB_ENV
          echo "VERCEL_PROJECT_ID=$VERCEL_PROJECT_ID" >> $GITHUB_ENV

      - name: Pull Vercel Environment Information
        run: |
          vercel pull --yes --environment=production --token=${{ env.VERCEL_TOKEN }}
          echo "Vercel files created:"
          ls -la .vercel/ 2>/dev/null || echo "No .vercel directory found"

      - name: Run database migrations
        env:
          DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
          DOTENV_PRIVATE_KEY_PRODUCTION: ${{ secrets.DOTENV_PRIVATE_KEY_PRODUCTION }}
        run: |
          # Load environment variables from Vercel and encrypted .env files
          # Vercel pull creates .vercel/.env.production.local with DATABASE_URL
          if [ -f .vercel/.env.production.local ]; then
            echo "Loading Vercel environment variables..."
            set -a
            source .vercel/.env.production.local
            set +a
          else
            echo "Warning: .vercel/.env.production.local not found"
            echo "Available .vercel files:"
            ls -la .vercel/ || echo "No .vercel directory"
          fi

          bunx dotenvx run -f projects/.env.production -f projects/.env -- \
            bunx cross-env NODE_ENV=production NODE_OPTIONS="--no-deprecation --import tsx" \
            PAYLOAD_CONFIG_PATH=src/payload.config.ts \
            payload migrate

      - name: Build Project Artifacts
        env:
          DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
          DOTENV_PRIVATE_KEY_PRODUCTION: ${{ secrets.DOTENV_PRIVATE_KEY_PRODUCTION }}
        run: vercel build --prod --token=${{ env.VERCEL_TOKEN }}

      - name: Deploy to Vercel (Production)
        id: deploy
        run: |
          url=$(vercel deploy --prebuilt --prod --token=${{ env.VERCEL_TOKEN }})
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "## Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- URL: $url" >> $GITHUB_STEP_SUMMARY

      - name: Production smoke test (homepage)
        run: |
          sleep 10
          url="${{ steps.deploy.outputs.url }}"
          curl -f --max-time 30 "$url" || exit 1

      - name: Production smoke test (blog)
        run: |
          url="${{ steps.deploy.outputs.url }}"
          curl -f --max-time 30 "$url/blog" || exit 1
