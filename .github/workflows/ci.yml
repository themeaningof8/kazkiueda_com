name: CI Pipeline

on:
  pull_request:
  push:
    branches: [main]

# PRの再pushで古い実行をキャンセル
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# 並列ジョブ間での環境変数の共有
env:
  NODE_ENV: test

jobs:
  # ==========================================
  # Stage 1: Static Analysis (最速)
  # ==========================================
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: TypeScript type check
        run: bunx tsc --noEmit

      - name: Biome lint
        run: bun run lint

      - name: Biome format check
        run: bun run check

  # ==========================================
  # Stage 2: Security & Code Quality
  # ==========================================
  security:
    name: Security & Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: static-analysis

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # 依存関係の脆弱性チェック
      - name: Audit dependencies
        run: bun pm audit
        continue-on-error: true

      # 循環依存の検出
      - name: Check circular dependencies
        run: bun run analyze:circular
        continue-on-error: true

      # 未使用のエクスポートを検出
      - name: Check for unused exports
        run: bun run analyze:unused
        continue-on-error: true

  # ==========================================
  # Stage 3: Unit Tests (高速)
  # ==========================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: static-analysis

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Debug - Check if DOTENV_PRIVATE_KEY_TEST is available
        run: |
          if [ -z "$DOTENV_PRIVATE_KEY_TEST" ]; then
            echo "❌ DOTENV_PRIVATE_KEY_TEST is not set"
            exit 1
          else
            echo "✅ DOTENV_PRIVATE_KEY_TEST is set (length: ${#DOTENV_PRIVATE_KEY_TEST})"
          fi
        env:
          DOTENV_PRIVATE_KEY_TEST: ${{ secrets.DOTENV_PRIVATE_KEY_TEST }}

      - name: Run unit tests with coverage
        run: bun run test:coverage:unit
        env:
          DOTENV_PRIVATE_KEY_TEST: ${{ secrets.DOTENV_PRIVATE_KEY_TEST }}

      - name: Upload coverage reports
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/coverage-final.json
          flags: unit
          name: unit-tests
          token: ${{ secrets.CODECOV_TOKEN }}
        if: always()

  # ==========================================
  # Stage 4: Integration Tests (中速)
  # ==========================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: unit-tests

    strategy:
      fail-fast: false
      matrix:
        suite:
          - name: payload-client
            script: test:integration:payload-client
          - name: posts
            script: test:integration:posts
          - name: server-actions
            script: test:integration:server-actions
          - name: safe-action
            script: test:integration:safe-action
          - name: collections-posts
            script: test:integration:collections-posts
          - name: collections-users
            script: test:integration:collections-users
          - name: collections-media
            script: test:integration:collections-media

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Debug - Check if DOTENV_PRIVATE_KEY_TEST is available
        run: |
          if [ -z "$DOTENV_PRIVATE_KEY_TEST" ]; then
            echo "❌ DOTENV_PRIVATE_KEY_TEST is not set"
            exit 1
          else
            echo "✅ DOTENV_PRIVATE_KEY_TEST is set (length: ${#DOTENV_PRIVATE_KEY_TEST})"
          fi
        env:
          DOTENV_PRIVATE_KEY_TEST: ${{ secrets.DOTENV_PRIVATE_KEY_TEST }}

      - name: Start test database
        run: bun run test:db:up

      - name: Run migrations
        run: bun run test:migrate
        env:
          DOTENV_PRIVATE_KEY_TEST: ${{ secrets.DOTENV_PRIVATE_KEY_TEST }}

      - name: Run integration tests - ${{ matrix.suite.name }}
        run: bun run ${{ matrix.suite.script }}
        env:
          DOTENV_PRIVATE_KEY_TEST: ${{ secrets.DOTENV_PRIVATE_KEY_TEST }}

      - name: Cleanup test database
        if: always()
        run: bun run test:db:down

  # ==========================================
  # Stage 5: Build Test
  # ==========================================
  build:
    name: Build Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [unit-tests, security]

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Debug - Check if secrets are available
        run: |
          echo "DOTENV_PRIVATE_KEY length: ${#DOTENV_PRIVATE_KEY}"
          echo "DOTENV_PRIVATE_KEY_PRODUCTION length: ${#DOTENV_PRIVATE_KEY_PRODUCTION}"
        env:
          DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
          DOTENV_PRIVATE_KEY_PRODUCTION: ${{ secrets.DOTENV_PRIVATE_KEY_PRODUCTION }}

      - name: Build application
        run: bun run build
        env:
          DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
          DOTENV_PRIVATE_KEY_PRODUCTION: ${{ secrets.DOTENV_PRIVATE_KEY_PRODUCTION }}

      - name: Check bundle size
        run: bun run analyze:size
        continue-on-error: true

      # ビルド成果物をキャッシュ（E2Eテストで使用可能）
      - name: Cache build
        uses: actions/cache@v4
        with:
          path: .next
          key: ${{ runner.os }}-build-${{ github.sha }}

  # ==========================================
  # Stage 6: E2E Tests (低速・最も重要)
  # ==========================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [integration-tests, build]

    strategy:
      fail-fast: false
      matrix:
        suite:
          - name: smoke
            file: tests/e2e/smoke-production.spec.ts
          - name: accessibility-essential
            file: tests/e2e/accessibility-essential.spec.ts
          - name: preview-essential
            file: tests/e2e/preview-essential.spec.ts
          - name: error-essential
            file: tests/e2e/error-essential.spec.ts

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        run: bun run test:e2e:install

      - name: Restore build cache
        uses: actions/cache@v4
        with:
          path: .next
          key: ${{ runner.os }}-build-${{ github.sha }}

      - name: Debug - Check if DOTENV_PRIVATE_KEY_TEST is available
        run: |
          if [ -z "$DOTENV_PRIVATE_KEY_TEST" ]; then
            echo "❌ DOTENV_PRIVATE_KEY_TEST is not set"
            exit 1
          else
            echo "✅ DOTENV_PRIVATE_KEY_TEST is set (length: ${#DOTENV_PRIVATE_KEY_TEST})"
          fi
        env:
          DOTENV_PRIVATE_KEY_TEST: ${{ secrets.DOTENV_PRIVATE_KEY_TEST }}

      - name: Start test database
        run: bun run test:db:up

      - name: Run migrations
        run: bun run test:migrate
        env:
          DOTENV_PRIVATE_KEY_TEST: ${{ secrets.DOTENV_PRIVATE_KEY_TEST }}

      - name: Start Next.js server
        run: |
          dotenvx run -f projects/.env.test -- bunx next dev --port 3001 > /tmp/next-dev.log 2>&1 &
          sleep 10
        env:
          DOTENV_PRIVATE_KEY_TEST: ${{ secrets.DOTENV_PRIVATE_KEY_TEST }}

      - name: Run E2E Tests - ${{ matrix.suite.name }}
        run: bunx playwright test ${{ matrix.suite.file }} --reporter=github
        env:
          CI: true
          DOTENV_PRIVATE_KEY_TEST: ${{ secrets.DOTENV_PRIVATE_KEY_TEST }}

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.suite.name }}
          path: playwright-report/
          retention-days: 30

      - name: Upload server logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: server-logs-${{ matrix.suite.name }}
          path: /tmp/next-dev.log
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          pkill -f 'next dev' || true
          bun run test:db:down

  # ==========================================
  # Final: Status Check (すべてのジョブ成功確認)
  # ==========================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [static-analysis, security, unit-tests, integration-tests, build, e2e-tests]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.static-analysis.result }}" != "success" ]] || \
             [[ "${{ needs.security.result }}" != "success" ]] || \
             [[ "${{ needs.unit-tests.result }}" != "success" ]] || \
             [[ "${{ needs.integration-tests.result }}" != "success" ]] || \
             [[ "${{ needs.build.result }}" != "success" ]] || \
             [[ "${{ needs.e2e-tests.result }}" != "success" ]]; then
            echo "❌ CI pipeline failed"
            exit 1
          fi
          echo "✅ All CI checks passed!"
