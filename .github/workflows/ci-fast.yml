name: CI Pipeline (Fast)

on:
  pull_request:
  push:
    branches: [main]

env:
  NODE_ENV: test

jobs:
  # ==========================================
  # Stage 1: Static Analysis (最速)
  # ==========================================
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: TypeScript & Lint (parallel)
        run: |
          bunx tsc --noEmit &
          bun run lint &
          wait

  # ==========================================
  # Stage 2: Tests (並列実行)
  # ==========================================
  tests:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: static-analysis

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Start test database
        run: bun run test:db:up

      - name: Run migrations
        run: bun run test:migrate
        env:
          DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
          PAYLOAD_SECRET: ${{ secrets.TEST_PAYLOAD_SECRET }}
          NODE_ENV: test

      # Unit と Integration を並列実行
      - name: Run tests in parallel
        run: |
          bun run test:coverage:unit &
          bun run test:integration:posts &
          bun run test:integration:server-actions &
          wait
        env:
          DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
          PAYLOAD_SECRET: ${{ secrets.TEST_PAYLOAD_SECRET }}
          PAYLOAD_PREVIEW_SECRET: ${{ secrets.TEST_PAYLOAD_PREVIEW_SECRET }}
          NODE_ENV: test

      - name: Cleanup
        if: always()
        run: bun run test:db:down

  # ==========================================
  # Stage 3: Build Test
  # ==========================================
  build:
    name: Build Test
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: static-analysis

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build application
        run: bun run build
        env:
          DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
          PAYLOAD_SECRET: ${{ secrets.TEST_PAYLOAD_SECRET }}
          NODE_ENV: production

  # ==========================================
  # Stage 4: E2E Smoke Tests (重要なもののみ)
  # ==========================================
  e2e-smoke:
    name: E2E Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: build

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        run: bun run test:e2e:install

      - name: Start test database
        run: bun run test:db:up

      - name: Run migrations
        run: bun run test:migrate
        env:
          DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
          PAYLOAD_SECRET: ${{ secrets.TEST_PAYLOAD_SECRET }}
          NODE_ENV: test

      - name: Start Next.js server
        run: |
          bunx next dev --port 3001 > /tmp/next-dev.log 2>&1 &
          sleep 10
        env:
          DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
          PAYLOAD_SECRET: ${{ secrets.TEST_PAYLOAD_SECRET }}
          PAYLOAD_PREVIEW_SECRET: ${{ secrets.TEST_PAYLOAD_PREVIEW_SECRET }}
          NODE_ENV: test

      # Smoke Testsのみ実行（5分以内）
      - name: Run E2E Smoke Tests
        run: bunx playwright test tests/e2e/smoke-production.spec.ts --reporter=github
        env:
          CI: true
          DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
          PAYLOAD_SECRET: ${{ secrets.TEST_PAYLOAD_SECRET }}
          PAYLOAD_PREVIEW_SECRET: ${{ secrets.TEST_PAYLOAD_PREVIEW_SECRET }}

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report-smoke
          path: playwright-report/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          pkill -f 'next dev' || true
          bun run test:db:down

  # ==========================================
  # Final: CI Success
  # ==========================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [static-analysis, tests, build, e2e-smoke]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.static-analysis.result }}" != "success" ]] || \
             [[ "${{ needs.tests.result }}" != "success" ]] || \
             [[ "${{ needs.build.result }}" != "success" ]] || \
             [[ "${{ needs.e2e-smoke.result }}" != "success" ]]; then
            echo "❌ CI pipeline failed"
            exit 1
          fi
          echo "✅ All CI checks passed!"
