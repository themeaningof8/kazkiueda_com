name: Reusable Tests

on:
  workflow_call:
    inputs:
      suite:
        description: "Test preset: static | unit | integration | e2e-essential | e2e-full"
        required: true
        type: string
      env-file:
        description: "Path to env file for dotenvx"
        required: false
        default: "projects/.env.development"
        type: string
      dotenv-key-name:
        description: "Secret name for DOTENV_PRIVATE_KEY_*"
        required: false
        default: "DOTENV_PRIVATE_KEY_DEVELOPMENT"
        type: string
      integration-script:
        description: "bun script for integration (e.g. test:integration:posts)"
        required: false
        default: ""
        type: string
      e2e-file:
        description: "Playwright spec file (glob). Empty = default per suite"
        required: false
        default: ""
        type: string
    secrets:
      DOTENV_PRIVATE_KEY_DEVELOPMENT:
        required: false
      DOTENV_PRIVATE_KEY_PRODUCTION:
        required: false

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      NODE_ENV: test
      DOTENV_PRIVATE_KEY_DEVELOPMENT: ${{ secrets.DOTENV_PRIVATE_KEY_DEVELOPMENT }}
      DOTENV_PRIVATE_KEY_PRODUCTION: ${{ secrets.DOTENV_PRIVATE_KEY_PRODUCTION }}
      # Override DATABASE_URL for CI test environment (docker-compose.test.yml)
      DATABASE_URL: postgresql://test:test@localhost:5433/kazkiueda_test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup environment keys
        run: |
          key_name="${{ inputs.dotenv-key-name }}"
          if [ "$key_name" = "DOTENV_PRIVATE_KEY_DEVELOPMENT" ]; then
            key_value="${{ secrets.DOTENV_PRIVATE_KEY_DEVELOPMENT }}"
          elif [ "$key_name" = "DOTENV_PRIVATE_KEY_PRODUCTION" ]; then
            key_value="${{ secrets.DOTENV_PRIVATE_KEY_PRODUCTION }}"
          fi
          echo "DOTENV_PRIVATE_KEY=$key_value" >> $GITHUB_ENV
          echo "$key_name=$key_value" >> $GITHUB_ENV

      - name: Setup (with Playwright when needed)
        uses: ./.github/actions/setup
        with:
          playwright: ${{ inputs.suite == 'e2e-essential' || inputs.suite == 'e2e-full' }}

      # ---------- Static ----------
      - name: Run static checks
        if: inputs.suite == 'static'
        run: |
          bunx tsc --noEmit
          bun run lint
          bun run check

      # ---------- Unit ----------
      - name: Run unit tests
        if: inputs.suite == 'unit'
        run: bun run test:coverage:unit

      # ---------- Integration ----------
      - name: Start test database
        if: inputs.suite == 'integration' || inputs.suite == 'e2e-essential' || inputs.suite == 'e2e-full'
        run: bun run test:db:up

      - name: Run migrations
        if: inputs.suite == 'integration' || inputs.suite == 'e2e-essential' || inputs.suite == 'e2e-full'
        run: bun run test:migrate

      - name: Run integration tests
        if: inputs.suite == 'integration'
        run: |
          if [ -n "${{ inputs.integration-script }}" ]; then
            bun run "${{ inputs.integration-script }}"
          else
            bun run test:integration:posts
            bun run test:integration:server-actions
          fi

      # ---------- E2E ----------
      - name: Cache Next.js build
        if: inputs.suite == 'e2e-essential' || inputs.suite == 'e2e-full'
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/bun.lockb') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx', '!node_modules/**') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/bun.lockb') }}-
            ${{ runner.os }}-nextjs-

      - name: Start Next.js server
        if: inputs.suite == 'e2e-essential' || inputs.suite == 'e2e-full'
        run: |
          bunx dotenvx run -f projects/.env -f projects/.env.development -- bun next dev --port 3001 > /tmp/next-dev.log 2>&1 &
          bunx wait-on http://localhost:3001 -t 60000

      - name: Run E2E tests
        if: inputs.suite == 'e2e-essential' || inputs.suite == 'e2e-full'
        env:
          CI: true
        run: |
          if [ "${{ inputs.e2e-file }}" != "" ]; then
            bunx dotenvx run -f projects/.env -f projects/.env.development -- bunx playwright test "${{ inputs.e2e-file }}" --reporter=github
          elif [ "${{ inputs.suite }}" = "e2e-essential" ]; then
            bunx dotenvx run -f projects/.env -f projects/.env.development -- bunx playwright test tests/e2e/*-essential.spec.ts --reporter=github
          else
            bunx dotenvx run -f projects/.env -f projects/.env.development -- bunx playwright test tests/e2e --reporter=github
          fi

      - name: Upload Playwright report
        if: always() && (inputs.suite == 'e2e-essential' || inputs.suite == 'e2e-full')
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ inputs.suite }}
          path: playwright-report/
          retention-days: 14

      - name: Upload server logs
        if: failure() && (inputs.suite == 'e2e-essential' || inputs.suite == 'e2e-full')
        uses: actions/upload-artifact@v4
        with:
          name: server-logs-${{ inputs.suite }}
          path: /tmp/next-dev.log
          retention-days: 7

      # ---------- Cleanup ----------
      - name: Stop Next.js server
        if: always() && (inputs.suite == 'e2e-essential' || inputs.suite == 'e2e-full')
        run: pkill -f 'next dev' || true

      - name: Stop test database
        if: always() && (inputs.suite == 'integration' || inputs.suite == 'e2e-essential' || inputs.suite == 'e2e-full')
        run: bun run test:db:down
