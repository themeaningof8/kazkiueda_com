name: Deploy to Staging

on:
  workflow_call:
    secrets:
      DOTENV_PRIVATE_KEY:
        required: true
      DOTENV_PRIVATE_KEY_DEVELOPMENT:
        required: true

concurrency:
  group: staging-deploy
  cancel-in-progress: false

env:
  NODE_ENV: production

jobs:
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Show deployment target
        run: |
          echo "## Staging Deployment Target" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: $(git rev-parse HEAD)" >> $GITHUB_STEP_SUMMARY
          echo "- Message: $(git log -1 --pretty=%B)" >> $GITHUB_STEP_SUMMARY

      - name: Install bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Vercel CLI
        run: bun install --global vercel@latest

      - name: Load Vercel configuration from dotenvx
        id: load-vercel-config
        env:
          DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
        run: |
          VERCEL_TOKEN=$(bunx dotenvx get VERCEL_TOKEN -f projects/.env)
          VERCEL_ORG_ID=$(bunx dotenvx get VERCEL_ORG_ID -f projects/.env)
          VERCEL_PROJECT_ID=$(bunx dotenvx get VERCEL_PROJECT_ID -f projects/.env)
          echo "::add-mask::$VERCEL_TOKEN"
          echo "::add-mask::$VERCEL_ORG_ID"
          echo "::add-mask::$VERCEL_PROJECT_ID"
          echo "VERCEL_TOKEN=$VERCEL_TOKEN" >> $GITHUB_ENV
          echo "VERCEL_ORG_ID=$VERCEL_ORG_ID" >> $GITHUB_ENV
          echo "VERCEL_PROJECT_ID=$VERCEL_PROJECT_ID" >> $GITHUB_ENV

      - name: Create Neon staging branch
        env:
          DOTENV_PRIVATE_KEY_DEVELOPMENT: ${{ secrets.DOTENV_PRIVATE_KEY_DEVELOPMENT }}
        run: |
          bunx dotenvx run -f projects/.env.development -- bun scripts/neon-branch.ts create staging-deploy

      - name: Update DATABASE_URL to use Neon staging branch
        run: echo "DATABASE_URL=$NEON_DATABASE_URL" >> $GITHUB_ENV

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ env.VERCEL_TOKEN }}

      - name: Run database migrations
        env:
          DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
        run: |
          bunx dotenvx run -f projects/.env -- \
            bunx cross-env DATABASE_URL=$DATABASE_URL NODE_ENV=production NODE_OPTIONS="--no-deprecation --import tsx" \
            PAYLOAD_CONFIG_PATH=src/payload.config.ts \
            payload migrate --yes

      - name: Build Project Artifacts
        env:
          DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
        run: |
          export DATABASE_URL=$DATABASE_URL
          vercel build --token=${{ env.VERCEL_TOKEN }}

      - name: Deploy to Vercel (Staging)
        id: deploy
        run: |
          export DATABASE_URL=$DATABASE_URL
          url=$(vercel deploy --prebuilt --token=${{ env.VERCEL_TOKEN }})
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "## Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- URL: $url" >> $GITHUB_STEP_SUMMARY

      - name: Update staging branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -B staging main
          git push -f origin staging

      - name: Staging smoke test (homepage)
        run: |
          sleep 10
          curl -f --max-time 30 "${{ steps.deploy.outputs.url }}" || exit 1

      - name: Staging smoke test (blog)
        run: |
          curl -f --max-time 30 "${{ steps.deploy.outputs.url }}/blog" || exit 1

      - name: Cleanup Neon staging branch
        if: always()
        env:
          DOTENV_PRIVATE_KEY_DEVELOPMENT: ${{ secrets.DOTENV_PRIVATE_KEY_DEVELOPMENT }}
        run: |
          bunx dotenvx run -f projects/.env.development -- bun scripts/neon-branch.ts delete staging-deploy || true
