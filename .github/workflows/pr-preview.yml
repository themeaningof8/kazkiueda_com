name: PR Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

# PRæ¯Žã«1ã¤ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒ
concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  NODE_ENV: production

jobs:
  # Vercel handles preview deployments automatically via GitHub integration
  # This workflow manages the database branch lifecycle for PR previews

  setup-preview-db:
    name: Setup Preview Database
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Create Neon preview branch
        env:
          DOTENV_PRIVATE_KEY_DEVELOPMENT: ${{ secrets.DOTENV_PRIVATE_KEY_DEVELOPMENT }}
        run: |
          bunx dotenvx run -f projects/.env.development -- bun scripts/neon-branch.ts create pr-${{ github.event.pull_request.number }}

      - name: Load Vercel configuration
        id: load-vercel-config
        env:
          DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
        run: |
          VERCEL_TOKEN=$(bunx dotenvx get VERCEL_TOKEN -f projects/.env)
          VERCEL_PROJECT_ID=$(bunx dotenvx get VERCEL_PROJECT_ID -f projects/.env)
          echo "::add-mask::$VERCEL_TOKEN"
          echo "::add-mask::$VERCEL_PROJECT_ID"
          echo "VERCEL_TOKEN=$VERCEL_TOKEN" >> $GITHUB_ENV
          echo "VERCEL_PROJECT_ID=$VERCEL_PROJECT_ID" >> $GITHUB_ENV

      - name: Set DATABASE_URL for this preview deployment
        env:
          GIT_BRANCH: ${{ github.head_ref }}
        run: |
          # Create or update environment variable for this specific git branch
          JSON_PAYLOAD=$(jq -n \
            --arg db "$NEON_DATABASE_URL" \
            --arg branch "$GIT_BRANCH" \
            '{
              key: "DATABASE_URL",
              value: $db,
              type: "encrypted",
              target: ["preview"],
              gitBranch: $branch
            }')

          curl -X POST "https://api.vercel.com/v10/projects/${{ env.VERCEL_PROJECT_ID }}/env" \
            -H "Authorization: Bearer ${{ env.VERCEL_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD"

      - name: Run database migrations on preview branch
        env:
          DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
          DOTENV_PRIVATE_KEY_DEVELOPMENT: ${{ secrets.DOTENV_PRIVATE_KEY_DEVELOPMENT }}
        run: |
          bunx dotenvx run -f projects/.env.development -f projects/.env -- \
            bunx cross-env DATABASE_URL=$NEON_DATABASE_URL NODE_ENV=production NODE_OPTIONS="--no-deprecation --import tsx" \
            PAYLOAD_CONFIG_PATH=src/payload.config.ts \
            payload migrate --yes

      - name: Comment on PR with preview info
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const branchName = context.payload.pull_request.head.ref;
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸŒ¿ Preview environment setup complete!\n\n` +
                    `âœ… Database branch created: \`pr-${prNumber}\`\n` +
                    `âœ… Database migrations applied\n` +
                    `âœ… Environment variable set for branch: \`${branchName}\`\n\n` +
                    `Vercel will automatically deploy the preview environment.`
            });

  cleanup-preview-db:
    name: Cleanup Preview Database
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Load Vercel configuration
        id: load-vercel-config
        env:
          DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
        run: |
          VERCEL_TOKEN=$(bunx dotenvx get VERCEL_TOKEN -f projects/.env)
          VERCEL_PROJECT_ID=$(bunx dotenvx get VERCEL_PROJECT_ID -f projects/.env)
          echo "::add-mask::$VERCEL_TOKEN"
          echo "::add-mask::$VERCEL_PROJECT_ID"
          echo "VERCEL_TOKEN=$VERCEL_TOKEN" >> $GITHUB_ENV
          echo "VERCEL_PROJECT_ID=$VERCEL_PROJECT_ID" >> $GITHUB_ENV

      - name: Get branch-specific environment variable ID
        id: get-env-id
        run: |
          # Get all environment variables for this project
          ENV_ID=$(curl -s "https://api.vercel.com/v9/projects/${{ env.VERCEL_PROJECT_ID }}/env" \
            -H "Authorization: Bearer ${{ env.VERCEL_TOKEN }}" | \
            jq -r '.envs[] | select(.key == "DATABASE_URL" and .gitBranch == "${{ github.head_ref }}") | .id' | head -n 1)

          if [ -n "$ENV_ID" ]; then
            echo "env_id=$ENV_ID" >> $GITHUB_OUTPUT
            echo "Found environment variable ID: $ENV_ID"
          else
            echo "No branch-specific DATABASE_URL found"
          fi

      - name: Delete branch-specific environment variable
        if: steps.get-env-id.outputs.env_id != ''
        run: |
          curl -X DELETE "https://api.vercel.com/v9/projects/${{ env.VERCEL_PROJECT_ID }}/env/${{ steps.get-env-id.outputs.env_id }}" \
            -H "Authorization: Bearer ${{ env.VERCEL_TOKEN }}"

      - name: Delete Neon preview branch
        env:
          DOTENV_PRIVATE_KEY_DEVELOPMENT: ${{ secrets.DOTENV_PRIVATE_KEY_DEVELOPMENT }}
        run: |
          bunx dotenvx run -f projects/.env.development -- bun scripts/neon-branch.ts delete pr-${{ github.event.pull_request.number }} || true

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ§¹ Preview environment cleaned up!\n\n` +
                    `âœ… Database branch deleted\n` +
                    `âœ… Environment variable removed`
            });
